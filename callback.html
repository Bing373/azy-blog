<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <title>GitHub 授权回调</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: "Microsoft YaHei", Arial, sans-serif;
            text-align: center;
            margin: 0;
            background-color: #f8f9fa;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 95vh;
            /* 添加底部填充，使内容上移 */
            padding: 0 0 5vh;
        }
        .container {
            max-width: 500px;
            width: 90%;
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-top: -5vh; /* 负边距使内容上移 */
        }
        h2 {
            color: #28a745;
            margin-top: 0;
        }
        .loading {
            margin: 20px 0;
        }
        .loading-spinner {
            display: inline-block;
            width: 50px;
            height: 50px;
            border: 5px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: #28a745;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .status-message {
            margin: 15px 0;
            line-height: 1.5;
        }
        .countdown {
            font-weight: bold;
            color: #28a745;
        }
        .error-message {
            color: #dc3545;
        }
        .close-btn {
            display: inline-block;
            background-color: #28a745;
            color: white;
            padding: 10px 20px;
            border-radius: 4px;
            text-decoration: none;
            margin-top: 20px;
            transition: background-color 0.3s;
            border: none;
            font-size: 16px;
            cursor: pointer;
        }
        .close-btn:hover {
            background-color: #218838;
        }
        .github-logo {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            border-radius: 50%;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 5px;
            background-color: white;
            transition: transform 0.3s ease;
        }
        .github-logo:hover {
            transform: scale(1.05);
        }
        .footer {
            margin-top: 20px;
            font-size: 12px;
            color: #6c757d;
        }
        /* 添加淡出动画 */
        .fade-out {
            animation: fadeOut 1s forwards;
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0.3; }
        }
        /* 添加完成标记样式 */
        .completion-mark {
            position: fixed;
            top: 10px;
            right: 10px;
            background-color: #28a745;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 100;
        }
        .completion-mark.error {
            background-color: #dc3545;
        }
    </style>
</head>
<body>
<div class="container">
    <img src="https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png" alt="GitHub Logo" class="github-logo">
    <h2>GitHub 授权处理中</h2>
    <p class="status-message">正在将授权信息传递给应用程序...</p>
    <div class="loading">
        <div class="loading-spinner"></div>
    </div>
    <div class="footer" id="copyright-footer">
        <!-- 版权信息将通过JavaScript动态生成 -->
    </div>
</div>

<script>
    // 生成动态版权信息
    function generateCopyright() {
        const startYear = 2024;
        const currentYear = new Date().getFullYear();
        let copyrightText = '';

        if (currentYear > startYear) {
            copyrightText = `© ${startYear}-${currentYear} By Bing373`;
        } else {
            copyrightText = `© ${startYear} By Bing373`;
        }

        document.getElementById('copyright-footer').textContent = copyrightText;
    }

    // 添加完成标记
    function addCompletionMark(isSuccess = true) {
        const mark = document.createElement('div');
        mark.className = 'completion-mark' + (isSuccess ? '' : ' error');
        mark.textContent = isSuccess ? '✓ 授权成功' : '授权失败';
        document.body.appendChild(mark);

        // 修改页面标题，在标题前添加标记
        document.title = isSuccess ? "[成功] " + document.title : "[失败] " + document.title;
    }

    // 调用生成版权信息函数
    generateCopyright();

    // 获取URL中的授权码
    const urlParams = new URLSearchParams(window.location.search);
    const code = urlParams.get('code');

    // 自动关闭页面的函数
    function autoCloseWindow(seconds, isSuccess = true) {
        let countdown = seconds;
        const countdownElement = document.getElementById('countdown');

        const interval = setInterval(() => {
            countdown--;
            if (countdownElement) {
                countdownElement.textContent = countdown;
            }

            if (countdown <= 0) {
                clearInterval(interval);

                // 尝试关闭窗口
                window.close();

                // 如果窗口没有关闭，淡出页面内容并显示完成标记
                setTimeout(() => {
                    const container = document.querySelector('.container');
                    if (container) {
                        container.classList.add('fade-out');

                        const closeElements = document.querySelectorAll('.auto-close-message');
                        closeElements.forEach(el => {
                            if (isSuccess) {
                                el.textContent = '授权成功';
                                el.style.color = '#28a745';
                            } else {
                                el.textContent = '授权失败';
                                el.style.color = '#17a2b8';
                            }
                        });

                        // 添加完成标记
                        addCompletionMark(isSuccess);
                    }
                }, 500);
            }
        }, 1000);
    }

    // 手动关闭窗口函数
    function closeWindow(isSuccess = true) {
        // 尝试关闭窗口
        window.close();

        // 如果窗口没有关闭，淡出页面内容并显示完成标记
        setTimeout(() => {
            const container = document.querySelector('.container');
            if (container) {
                container.classList.add('fade-out');

                // 添加完成标记
                addCompletionMark(isSuccess);

                // 更新容器内容
                if (isSuccess) {
                    container.innerHTML = `
                            <img src="https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png" alt="GitHub Logo" class="github-logo">
                            <h2 style="color: #28a745;">授权成功</h2>
                            <p>您可以安全地关闭此页面</p>
                            <div class="footer" id="success-copyright">© 2024 By Bing373</div>
                        `;
                } else {
                    container.innerHTML = `
                            <img src="https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png" alt="GitHub Logo" class="github-logo">
                            <h2 style="color: #17a2b8;">授权失败</h2>
                            <p>请确保应用程序正在运行</p>
                            <p>您可以关闭此页面，并重新尝试登录</p>
                            <div class="footer" id="error-copyright">© 2024 By Bing373</div>
                        `;
                }
            }
        }, 300);
    }

    if (code) {
        // 尝试将授权码发送到本地应用
        fetch(`http://localhost:8000/receive_code?code=${code}`, {
            method: 'GET',
            mode: 'no-cors'
        }).then(() => {
            document.querySelector('.container').innerHTML = `
                    <img src="https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png" alt="GitHub Logo" class="github-logo">
                    <h2>授权成功！</h2>
                    <p class="status-message">授权信息已成功传递给应用程序</p>
                    <p class="status-message">请返回应用程序继续操作</p>
                    <div class="footer" id="success-copyright">
                        <!-- 版权信息将通过JavaScript动态生成 -->
                    </div>
                `;

            // 更新成功页面的版权信息
            const startYear = 2024;
            const currentYear = new Date().getFullYear();
            let copyrightText = '';

            if (currentYear > startYear) {
                copyrightText = `© ${startYear}-${currentYear} By Bing373`;
            } else {
                copyrightText = `© ${startYear} By Bing373`;
            }

            document.getElementById('success-copyright').textContent = copyrightText;

            // 启动自动关闭倒计时
            autoCloseWindow(5, true);

        }).catch(error => {
            document.querySelector('.container').innerHTML = `
                    <img src="https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png" alt="GitHub Logo" class="github-logo">
                    <h2 style="color: #17a2b8;">授权未完成</h2>
                    <p class="status-message">无法连接到应用程序</p>
                    <p class="status-message">请确保应用程序正在运行</p>
                    <div class="footer" id="error-copyright">
                        <!-- 版权信息将通过JavaScript动态生成 -->
                    </div>
                `;

            // 更新错误页面的版权信息
            const startYear = 2024;
            const currentYear = new Date().getFullYear();
            let copyrightText = '';

            if (currentYear > startYear) {
                copyrightText = `© ${startYear}-${currentYear} By Bing373`;
            } else {
                copyrightText = `© ${startYear} By Bing373`;
            }

            document.getElementById('error-copyright').textContent = copyrightText;

            // 启动自动关闭倒计时
            autoCloseWindow(5, false);
        });
    } else {
        document.querySelector('.container').innerHTML = `
                <img src="https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png" alt="GitHub Logo" class="github-logo">
                <h2 style="color: #17a2b8;">授权未完成</h2>
                <p class="status-message">未能获取到授权码</p>
                <p class="status-message">请返回应用程序重新尝试登录</p>
                <div class="footer" id="fail-copyright">
                    <!-- 版权信息将通过JavaScript动态生成 -->
                </div>
            `;

        // 更新失败页面的版权信息
        const startYear = 2024;
        const currentYear = new Date().getFullYear();
        let copyrightText = '';

        if (currentYear > startYear) {
            copyrightText = `© ${startYear}-${currentYear} By Bing373`;
        } else {
            copyrightText = `© ${startYear} By Bing373`;
        }

        document.getElementById('fail-copyright').textContent = copyrightText;

        // 启动自动关闭倒计时
        autoCloseWindow(5, false);
    }
</script>
</body>
</html>