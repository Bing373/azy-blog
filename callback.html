<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <title>GitHub 授权</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: "Microsoft YaHei", Arial, sans-serif;
            text-align: center;
            margin: 0;
            background-color: #f8f9fa;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 95vh;
            /* 添加底部填充，使内容上移 */
            padding: 0 0 5vh;
        }
        .container {
            max-width: 500px;
            width: 90%;
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-top: -5vh; /* 负边距使内容上移 */
        }
        h2 {
            color: #28a745;
            margin-top: 0;
        }
        .loading {
            margin: 20px 0;
        }
        .loading-spinner {
            display: inline-block;
            width: 50px;
            height: 50px;
            border: 5px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: #28a745;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .status-message {
            margin: 15px 0;
            line-height: 1.5;
        }
        .countdown {
            font-weight: bold;
            color: #28a745;
        }
        .error-message {
            color: #dc3545;
        }
        .github-logo {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            border-radius: 50%;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 5px;
            background-color: white;
            transition: transform 0.3s ease;
        }
        .github-logo:hover {
            transform: scale(1.05);
        }
        .footer {
            margin-top: 20px;
            font-size: 12px;
            color: #6c757d;
        }
        /* 倒计时圆环 */
        .countdown-circle {
            position: relative;
            width: 60px;
            height: 60px;
            margin: 20px auto 10px;
        }
        .countdown-circle svg {
            transform: rotate(-90deg);
        }
        .countdown-circle circle {
            fill: none;
            stroke-width: 5;
        }
        .countdown-circle .bg {
            stroke: #f0f0f0;
        }
        .countdown-circle .progress {
            stroke: #28a745;
            stroke-linecap: round;
            transition: stroke-dashoffset 1s linear;
        }
        .countdown-circle .progress.error {
            stroke: #dc3545;
        }
        .countdown-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 18px;
            font-weight: bold;
        }
    </style>
</head>
<body>
<div class="container">
    <img src="https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png" alt="GitHub Logo" class="github-logo">
    <h2>GitHub 授权处理中</h2>
    <p class="status-message">正在将授权信息传递给应用程序...</p>
    <div class="loading">
        <div class="loading-spinner"></div>
    </div>
    <div class="footer" id="copyright-footer">
        <!-- 版权信息将通过JavaScript动态生成 -->
    </div>
</div>

<script>
    // 生成动态版权信息
    function generateCopyright() {
        const startYear = 2024;
        const currentYear = new Date().getFullYear();
        let copyrightText = '';

        if (currentYear > startYear) {
            copyrightText = `© ${startYear}-${currentYear} By Bing373`;
        } else {
            copyrightText = `© ${startYear} By Bing373`;
        }

        return copyrightText;
    }

    // 初始化版权信息
    document.getElementById('copyright-footer').textContent = generateCopyright();

    // 创建倒计时圆环
    function createCountdownCircle(container, seconds, isSuccess = true) {
        const circumference = 2 * Math.PI * 25; // 圆周长

        const countdownCircle = document.createElement('div');
        countdownCircle.className = 'countdown-circle';
        countdownCircle.innerHTML = `
            <svg width="60" height="60">
                <circle class="bg" cx="30" cy="30" r="25" />
                <circle class="progress ${isSuccess ? '' : 'error'}" cx="30" cy="30" r="25"
                    stroke-dasharray="${circumference}"
                    stroke-dashoffset="0" />
            </svg>
            <div class="countdown-text">${seconds}</div>
        `;

        // 找到 footer 元素
        const footer = container.querySelector('.footer');

        // 在 footer 之前插入倒计时圆环
        container.insertBefore(countdownCircle, footer);

        return {
            element: countdownCircle,
            progressCircle: countdownCircle.querySelector('.progress'),
            textElement: countdownCircle.querySelector('.countdown-text'),
            circumference: circumference
        };
    }

    // 更新倒计时圆环
    function updateCountdownCircle(countdownObj, secondsLeft, totalSeconds) {
        const progress = secondsLeft / totalSeconds;
        const dashoffset = countdownObj.circumference * (1 - progress);

        countdownObj.progressCircle.style.strokeDashoffset = dashoffset;
        countdownObj.textElement.textContent = secondsLeft;
    }

    // 获取URL中的授权码
    const urlParams = new URLSearchParams(window.location.search);
    const code = urlParams.get('code');

    // 自动关闭页面的函数
    function autoCloseWindow(seconds, isSuccess = true) {
        let countdown = seconds;
        const container = document.querySelector('.container');

        // 创建倒计时圆环
        const countdownObj = createCountdownCircle(container, seconds, isSuccess);

        const interval = setInterval(() => {
            countdown--;

            // 更新倒计时圆环
            updateCountdownCircle(countdownObj, countdown, seconds);

            if (countdown <= 0) {
                clearInterval(interval);

                // 尝试关闭窗口
                const closeAttempt = window.close();

                // 如果窗口没有关闭，更新容器内容
                setTimeout(() => {
                    if (container) {
                        // 修改页面标题，在标题前添加标记
                        document.title = isSuccess ? "[成功] " + document.title : "[失败] " + document.title;

                        // 获取版权信息
                        const copyrightText = generateCopyright();

                        // 更新容器内容
                        if (isSuccess) {
                            container.innerHTML = `
                                <img src="https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png" alt="GitHub Logo" class="github-logo">
                                <h2 style="color: #28a745;">请手动关闭</h2>
                                <p>授权已成功完成，可以安全地关闭此页面</p>
                                <p></p>
                                <div class="footer" id="success-copyright">${copyrightText}</div>
                            `;
                        } else {
                            container.innerHTML = `
                                <img src="https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png" alt="GitHub Logo" class="github-logo">
                                <h2 style="color: #dc3545;">请手动关闭</h2>
                                <p>由于浏览器安全限制，此页面无法自动关闭</p>
                                <p></p>
                                <div class="footer" id="error-copyright">${copyrightText}</div>
                            `;
                        }
                    }
                }, 500);
            }
        }, 1000);
    }

    if (code) {
        // 尝试将授权码发送到本地应用
        fetch(`http://localhost:8000/receive_code?code=${code}`, {
            method: 'GET',
            mode: 'no-cors'
        }).then(() => {
            // 获取版权信息
            const copyrightText = generateCopyright();

            document.querySelector('.container').innerHTML = `
                <img src="https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png" alt="GitHub Logo" class="github-logo">
                <h2>授权成功！</h2>
                <p class="status-message">授权信息已成功传递给应用程序</p>
                <p class="status-message">请返回应用程序继续操作</p>
                <p class="status-message">此页面将在5秒后自动关闭</p>
                <div class="footer" id="success-copyright">${copyrightText}</div>
            `;

            // 启动自动关闭倒计时
            autoCloseWindow(5, true);

        }).catch(error => {
            // 获取版权信息
            const copyrightText = generateCopyright();

            document.querySelector('.container').innerHTML = `
                <img src="https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png" alt="GitHub Logo" class="github-logo">
                <h2 style="color: #dc3545;">授权未完成</h2>
                <p class="status-message">无法连接到应用程序</p>
                <p class="status-message">请确保应用程序正在运行</p>
                <p class="status-message">此页面将在5秒后自动关闭</p>
                <div class="footer" id="error-copyright">${copyrightText}</div>
            `;

            // 启动自动关闭倒计时，失败状态也自动关闭
            autoCloseWindow(5, false);
        });
    } else {
        // 获取版权信息
        const copyrightText = generateCopyright();

        document.querySelector('.container').innerHTML = `
            <img src="https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png" alt="GitHub Logo" class="github-logo">
            <h2 style="color: #dc3545;">授权未完成</h2>
            <p class="status-message">未能获取到授权码</p>
            <p class="status-message">请返回应用程序重新尝试登录</p>
            <p class="status-message">此页面将在5秒后自动关闭</p>
            <div class="footer" id="fail-copyright">${copyrightText}</div>
        `;

        // 启动自动关闭倒计时，失败状态也自动关闭
        autoCloseWindow(5, false);
    }
</script>
</body>
</html>